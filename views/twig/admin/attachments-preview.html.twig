{% if images is not empty %}
    {% set carouselId = 'carousel-' ~ random() %}
    {% set lightboxId = 'lightbox-' ~ random() %}
    {% set CAROUSEL_TYPE = CAROUSEL_TYPE|default('horizontal') %}
    {% if CAROUSEL_TYPE == 'multiple' and images|length == 1 %}
        {% set CAROUSEL_TYPE = 'single' %}
    {% endif %}

    {# TIPO 1: SINGLE - Un'immagine alla volta (originale) #}
    {% if CAROUSEL_TYPE == 'single' %}
        <div id="{{ carouselId }}" class="carousel slide" data-ride="carousel" data-interval="2000" style="min-width: 300px;">
            <ol class="carousel-indicators">
                {% for item in images %}
                <li data-target="#{{ carouselId }}" data-slide-to="{{ loop.index0 }}" {% if loop.first %}class="active"{% endif %}></li>
                {% endfor %}
            </ol>
            
            <div class="carousel-inner">
                {% for item in images %}
                <div class="carousel-item {% if loop.first %}active{% endif %}">
                    <img src="{{ item.filename }}" class="d-block w-100 mpnotes-attachment-img img-preview-carousel" alt="{{ item.filetitle }}" data-id-attachment="{{ item.id }}" data-lightbox="{{ lightboxId }}" data-title="{{ item.filetitle }}">
                    <div class="carousel-caption d-block" style="position: relative; background: rgba(0,0,0,0.7); padding: 5px; bottom: 0; left: 0; right: 0;">
                        <p class="mb-0" style="font-size: 0.85rem; color: #fff;">{{ item.filetitle }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if images|length > 1 %}
            <a class="carousel-control-prev" href="#{{ carouselId }}" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#{{ carouselId }}" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
            {% endif %}
        </div>

    {# TIPO 3: HORIZONTAL - Tutte le immagini in scroll orizzontale #}
    {% elseif CAROUSEL_TYPE == 'horizontal' %}
        <div class="d-flex gap-2" style="overflow-x: auto; min-width: auto; padding: 5px;">
            {% for item in images %}
            <div style="min-width: 100px; flex-shrink: 0;">
                <img src="{{ item.filename }}" class="d-block w-100 mpnotes-attachment-img img-preview-carousel" alt="{{ item.filetitle }}" data-id-attachment="{{ item.id }}" data-lightbox="{{ lightboxId }}" data-title="{{ item.filetitle }}">
                <p class="text-center mb-0" style="font-size: 0.75rem; background: rgba(0,0,0,0.7); color: #fff; padding: 3px; margin-top: 2px; border-radius: 3px;">{{ item.filetitle }}</p>
            </div>
            {% endfor %}
        </div>
    {% endif %}
{% else %}
    <div class="alert alert-warning">Nessun allegato</div>
{% endif %}
